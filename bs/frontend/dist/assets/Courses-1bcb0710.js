import{_ as Be,h as s,v as je,j as Fe,a as f,E as u,b as d,k as Oe,o as v,c as k,e as t,w as o,d as p,f as c,z as ne,A as se,x as ue,F as j,s as F,m as de,g as D,t as w,n as Ae}from"./index-48d38f36.js";const Ne={class:"admin-courses-container"},Pe={class:"card-header"},Ke={class:"header-actions"},Qe={class:"filter-container"},He={class:"pagination-container"},Ge={class:"dialog-footer"},Je={key:0,class:"course-info"},We={class:"student-search"},Xe={class:"student-pagination"},Ze={class:"dialog-footer"},et={class:"import-container"},tt={class:"import-actions"},at={__name:"Courses",setup(lt){const O=s(!1),A=s(!1),J=s([]),W=s(0),U=s(1),z=s(10),X=s([]),Z=s(0),C=s(1),I=s(10),Y=s(""),m=s(null),$=s(""),E=s(""),M=s(""),L=s(""),N=s([]),P=s([]),V=s(!1),R=s(!1),T=s(!1),q=s(!1),K=s(null),n=je({id:"",courseCode:"",name:"",categoryId:"",teacherId:"",credits:3,capacity:50,description:"",startDate:"",endDate:"",status:"pending"}),ie={courseCode:[{required:!0,message:"请输入课程编号",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],name:[{required:!0,message:"请输入课程名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],categoryId:[{required:!0,message:"请选择课程类别",trigger:"change"}],teacherId:[{required:!0,message:"请选择授课教师",trigger:"change"}],credits:[{required:!0,message:"请输入学分",trigger:"blur"}],capacity:[{required:!0,message:"请输入容量",trigger:"blur"}],startDate:[{required:!0,message:"请选择开始日期",trigger:"change"}],endDate:[{required:!0,message:"请选择结束日期",trigger:"change"}],status:[{required:!0,message:"请选择课程状态",trigger:"change"}]},ce={Authorization:`Bearer ${localStorage.getItem("token")}`};Fe(()=>{_(),pe(),me()});const _=async()=>{O.value=!0;try{const l={page:U.value,limit:z.value,search:$.value,category:E.value,status:M.value,teacherId:L.value},e=await f.get("/admin/courses",{params:l});J.value=e.data.courses,W.value=e.data.total}catch(l){console.error("加载课程失败:",l),u.error("加载课程列表失败")}finally{O.value=!1}},pe=async()=>{try{const l=await f.get("/course/categories");N.value=l.data.map(e=>({value:e.id,label:e.name}))}catch(l){console.error("加载课程类别失败:",l),u.error("加载课程类别失败")}},me=async()=>{try{const l=await f.get("/admin/teachers");P.value=l.data.map(e=>({id:e.id,name:e.name}))}catch(l){console.error("加载教师列表失败:",l),u.error("加载教师列表失败")}},ve=l=>{switch(l){case"active":return"success";case"ended":return"info";case"pending":return"warning";default:return""}},ge=l=>{switch(l){case"active":return"进行中";case"ended":return"已结束";case"pending":return"未开始";default:return"未知"}},h=()=>{U.value=1,_()},fe=l=>{z.value=l,_()},be=l=>{U.value=l,_()},ye=()=>{q.value=!1,Object.keys(n).forEach(l=>{l!=="credits"&&l!=="capacity"&&l!=="status"&&(n[l]="")}),n.credits=3,n.capacity=50,n.status="pending",V.value=!0},_e=l=>{q.value=!0,Object.keys(n).forEach(e=>{n[e]=l[e]}),V.value=!0},we=async()=>{K.value&&await K.value.validate(async l=>{if(l)try{q.value?(await f.put(`/admin/courses/${n.id}`,n),u.success("课程更新成功")):(await f.post("/admin/courses",n),u.success("课程添加成功")),V.value=!1,_()}catch(e){console.error("保存课程失败:",e),u.error("保存课程失败")}})},Ce=async l=>{try{await f.delete(`/admin/courses/${l}`),u.success("课程删除成功"),_()}catch(e){console.error("删除课程失败:",e),u.error("删除课程失败")}},Ve=async l=>{m.value=l,C.value=1,Y.value="",R.value=!0,S()},S=async()=>{if(m.value){A.value=!0;try{const l={page:C.value,limit:I.value,search:Y.value},e=await f.get(`/admin/courses/${m.value.id}/students`,{params:l});X.value=e.data.students,Z.value=e.data.total}catch(l){console.error("加载课程学生失败:",l),u.error("加载课程学生列表失败")}finally{A.value=!1}}},Q=()=>{C.value=1,S()},he=l=>{I.value=l,S()},xe=l=>{C.value=l,S()},ke=async l=>{try{await f.delete(`/admin/courses/${m.value.id}/students/${l}`),u.success("学生已从课程中移除"),S(),_()}catch(e){console.error("移除学生失败:",e),u.error("移除学生失败")}},De=async()=>{try{const l=await f.get(`/admin/courses/${m.value.id}/students/export`,{responseType:"blob"}),e=window.URL.createObjectURL(new Blob([l.data])),r=document.createElement("a");r.href=e,r.setAttribute("download",`${m.value.name}-学生名单.xlsx`),document.body.appendChild(r),r.click(),document.body.removeChild(r),u.success("学生名单导出成功")}catch(l){console.error("导出学生名单失败:",l),u.error("导出学生名单失败")}},Ue=()=>{T.value=!0},Se=async()=>{try{const l=await f.get("/admin/courses/import/template",{responseType:"blob"}),e=window.URL.createObjectURL(new Blob([l.data])),r=document.createElement("a");r.href=e,r.setAttribute("download","课程导入模板.xlsx"),document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(l){console.error("下载导入模板失败:",l),u.error("下载导入模板失败")}},ze=l=>{const e=l.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||l.type==="application/vnd.ms-excel",r=l.size/1024/1024<2;return e||u.error("只能上传Excel文件!"),r||u.error("文件大小不能超过2MB!"),e&&r},Ie=l=>{u.success(`成功导入${l.imported}条课程数据`),T.value=!1,_()},Ye=l=>{console.error("导入失败:",l),u.error("导入课程数据失败")},$e=async()=>{try{const l={search:$.value,category:E.value,status:M.value,teacherId:L.value},e=await f.get("/admin/courses/export",{params:l,responseType:"blob"}),r=window.URL.createObjectURL(new Blob([e.data])),g=document.createElement("a");g.href=r,g.setAttribute("download","课程列表.xlsx"),document.body.appendChild(g),g.click(),document.body.removeChild(g),u.success("课程列表导出成功")}catch(l){console.error("导出课程列表失败:",l),u.error("导出课程列表失败")}};return(l,e)=>{const r=d("el-button"),g=d("el-input"),B=d("el-col"),b=d("el-option"),x=d("el-select"),Ee=d("el-row"),i=d("el-table-column"),Me=d("el-tag"),ee=d("el-popconfirm"),te=d("el-table"),ae=d("el-pagination"),Le=d("el-card"),y=d("el-form-item"),le=d("el-input-number"),oe=d("el-date-picker"),Re=d("el-form"),H=d("el-dialog"),Te=d("el-alert"),qe=d("el-upload"),re=Oe("loading");return v(),k("div",Ne,[t(Le,{class:"box-card"},{header:o(()=>[p("div",Pe,[e[27]||(e[27]=p("h2",null,"课程管理",-1)),p("div",Ke,[t(r,{type:"primary",onClick:ye},{default:o(()=>[...e[24]||(e[24]=[c("添加课程",-1)])]),_:1}),t(r,{type:"success",onClick:Ue},{default:o(()=>[...e[25]||(e[25]=[c("批量导入",-1)])]),_:1}),t(r,{type:"info",onClick:$e},{default:o(()=>[...e[26]||(e[26]=[c("导出课程",-1)])]),_:1})])])]),default:o(()=>[p("div",Qe,[t(Ee,{gutter:20},{default:o(()=>[t(B,{span:6},{default:o(()=>[t(g,{modelValue:$.value,"onUpdate:modelValue":e[0]||(e[0]=a=>$.value=a),placeholder:"搜索课程名称或编号",clearable:"",onClear:h,onKeyup:ne(h,["enter"])},{append:o(()=>[t(r,{icon:se(ue),onClick:h},null,8,["icon"])]),_:1},8,["modelValue"])]),_:1}),t(B,{span:6},{default:o(()=>[t(x,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=a=>E.value=a),placeholder:"课程类别",clearable:"",onChange:h},{default:o(()=>[(v(!0),k(j,null,F(N.value,a=>(v(),D(b,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(B,{span:6},{default:o(()=>[t(x,{modelValue:M.value,"onUpdate:modelValue":e[2]||(e[2]=a=>M.value=a),placeholder:"课程状态",clearable:"",onChange:h},{default:o(()=>[t(b,{label:"进行中",value:"active"}),t(b,{label:"已结束",value:"ended"}),t(b,{label:"未开始",value:"pending"})]),_:1},8,["modelValue"])]),_:1}),t(B,{span:6},{default:o(()=>[t(x,{modelValue:L.value,"onUpdate:modelValue":e[3]||(e[3]=a=>L.value=a),placeholder:"授课教师",clearable:"",onChange:h},{default:o(()=>[(v(!0),k(j,null,F(P.value,a=>(v(),D(b,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),de((v(),D(te,{data:J.value,style:{width:"100%","margin-top":"20px"},border:""},{default:o(()=>[t(i,{prop:"courseCode",label:"课程编号",width:"120"}),t(i,{prop:"name",label:"课程名称",width:"180"}),t(i,{prop:"category",label:"课程类别",width:"120"}),t(i,{prop:"teacherName",label:"授课教师",width:"120"}),t(i,{prop:"credits",label:"学分",width:"80"}),t(i,{prop:"capacity",label:"容量",width:"80"}),t(i,{prop:"enrolled",label:"已选人数",width:"100"}),t(i,{label:"状态",width:"100"},{default:o(a=>[t(Me,{type:ve(a.row.status)},{default:o(()=>[c(w(ge(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(i,{label:"操作",width:"220"},{default:o(a=>[t(r,{size:"small",onClick:G=>_e(a.row)},{default:o(()=>[...e[28]||(e[28]=[c("编辑",-1)])]),_:1},8,["onClick"]),t(r,{size:"small",type:"primary",onClick:G=>Ve(a.row)},{default:o(()=>[...e[29]||(e[29]=[c("查看学生",-1)])]),_:1},8,["onClick"]),t(ee,{title:"确定要删除此课程吗？",onConfirm:G=>Ce(a.row.id)},{reference:o(()=>[t(r,{size:"small",type:"danger"},{default:o(()=>[...e[30]||(e[30]=[c("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[re,O.value]]),p("div",He,[t(ae,{"current-page":U.value,"onUpdate:currentPage":e[4]||(e[4]=a=>U.value=a),"page-size":z.value,"onUpdate:pageSize":e[5]||(e[5]=a=>z.value=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:W.value,onSizeChange:fe,onCurrentChange:be},null,8,["current-page","page-size","total"])])]),_:1}),t(H,{modelValue:V.value,"onUpdate:modelValue":e[17]||(e[17]=a=>V.value=a),title:q.value?"编辑课程":"添加课程",width:"50%"},{footer:o(()=>[p("span",Ge,[t(r,{onClick:e[16]||(e[16]=a=>V.value=!1)},{default:o(()=>[...e[31]||(e[31]=[c("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:we},{default:o(()=>[...e[32]||(e[32]=[c("确认",-1)])]),_:1})])]),default:o(()=>[t(Re,{ref_key:"courseFormRef",ref:K,model:n,rules:ie,"label-width":"100px"},{default:o(()=>[t(y,{label:"课程编号",prop:"courseCode"},{default:o(()=>[t(g,{modelValue:n.courseCode,"onUpdate:modelValue":e[6]||(e[6]=a=>n.courseCode=a)},null,8,["modelValue"])]),_:1}),t(y,{label:"课程名称",prop:"name"},{default:o(()=>[t(g,{modelValue:n.name,"onUpdate:modelValue":e[7]||(e[7]=a=>n.name=a)},null,8,["modelValue"])]),_:1}),t(y,{label:"课程类别",prop:"categoryId"},{default:o(()=>[t(x,{modelValue:n.categoryId,"onUpdate:modelValue":e[8]||(e[8]=a=>n.categoryId=a),placeholder:"选择课程类别"},{default:o(()=>[(v(!0),k(j,null,F(N.value,a=>(v(),D(b,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"授课教师",prop:"teacherId"},{default:o(()=>[t(x,{modelValue:n.teacherId,"onUpdate:modelValue":e[9]||(e[9]=a=>n.teacherId=a),placeholder:"选择授课教师"},{default:o(()=>[(v(!0),k(j,null,F(P.value,a=>(v(),D(b,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(y,{label:"学分",prop:"credits"},{default:o(()=>[t(le,{modelValue:n.credits,"onUpdate:modelValue":e[10]||(e[10]=a=>n.credits=a),min:0,max:10},null,8,["modelValue"])]),_:1}),t(y,{label:"容量",prop:"capacity"},{default:o(()=>[t(le,{modelValue:n.capacity,"onUpdate:modelValue":e[11]||(e[11]=a=>n.capacity=a),min:1,max:500},null,8,["modelValue"])]),_:1}),t(y,{label:"课程描述",prop:"description"},{default:o(()=>[t(g,{modelValue:n.description,"onUpdate:modelValue":e[12]||(e[12]=a=>n.description=a),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),t(y,{label:"开始日期",prop:"startDate"},{default:o(()=>[t(oe,{modelValue:n.startDate,"onUpdate:modelValue":e[13]||(e[13]=a=>n.startDate=a),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(y,{label:"结束日期",prop:"endDate"},{default:o(()=>[t(oe,{modelValue:n.endDate,"onUpdate:modelValue":e[14]||(e[14]=a=>n.endDate=a),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(y,{label:"状态",prop:"status"},{default:o(()=>[t(x,{modelValue:n.status,"onUpdate:modelValue":e[15]||(e[15]=a=>n.status=a),placeholder:"选择课程状态"},{default:o(()=>[t(b,{label:"进行中",value:"active"}),t(b,{label:"已结束",value:"ended"}),t(b,{label:"未开始",value:"pending"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(H,{modelValue:R.value,"onUpdate:modelValue":e[22]||(e[22]=a=>R.value=a),title:"课程学生列表",width:"70%"},{footer:o(()=>[p("span",Ze,[t(r,{onClick:De},{default:o(()=>[...e[34]||(e[34]=[c("导出学生名单",-1)])]),_:1}),t(r,{type:"primary",onClick:e[21]||(e[21]=a=>R.value=!1)},{default:o(()=>[...e[35]||(e[35]=[c("关闭",-1)])]),_:1})])]),default:o(()=>[m.value?(v(),k("div",Je,[p("h3",null,w(m.value.name)+" ("+w(m.value.courseCode)+")",1),p("p",null,"授课教师: "+w(m.value.teacherName)+" | 已选人数: "+w(m.value.enrolled)+"/"+w(m.value.capacity),1)])):Ae("",!0),p("div",We,[t(g,{modelValue:Y.value,"onUpdate:modelValue":e[18]||(e[18]=a=>Y.value=a),placeholder:"搜索学生姓名或学号",clearable:"",onClear:Q,onKeyup:ne(Q,["enter"])},{append:o(()=>[t(r,{icon:se(ue),onClick:Q},null,8,["icon"])]),_:1},8,["modelValue"])]),de((v(),D(te,{data:X.value,style:{width:"100%","margin-top":"20px"},border:""},{default:o(()=>[t(i,{prop:"studentId",label:"学号",width:"120"}),t(i,{prop:"name",label:"姓名",width:"120"}),t(i,{prop:"gender",label:"性别",width:"80"},{default:o(a=>[c(w(a.row.gender==="male"?"男":"女"),1)]),_:1}),t(i,{prop:"major",label:"专业",width:"150"}),t(i,{prop:"class",label:"班级",width:"120"}),t(i,{prop:"enrollDate",label:"选课日期",width:"120"}),t(i,{label:"出勤率",width:"100"},{default:o(a=>[c(w(a.row.attendanceRate||"0")+"% ",1)]),_:1}),t(i,{label:"操作",width:"150"},{default:o(a=>[t(ee,{title:"确定要将此学生从课程中移除吗？",onConfirm:G=>ke(a.row.id)},{reference:o(()=>[t(r,{size:"small",type:"danger"},{default:o(()=>[...e[33]||(e[33]=[c("移除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[re,A.value]]),p("div",Xe,[t(ae,{"current-page":C.value,"onUpdate:currentPage":e[19]||(e[19]=a=>C.value=a),"page-size":I.value,"onUpdate:pageSize":e[20]||(e[20]=a=>I.value=a),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",total:Z.value,onSizeChange:he,onCurrentChange:xe},null,8,["current-page","page-size","total"])])]),_:1},8,["modelValue"]),t(H,{modelValue:T.value,"onUpdate:modelValue":e[23]||(e[23]=a=>T.value=a),title:"批量导入课程",width:"50%"},{default:o(()=>[p("div",et,[t(Te,{title:"请使用指定格式的Excel文件进行导入",type:"info",description:"文件应包含以下列：课程编号、课程名称、课程类别ID、教师ID、学分、容量、描述、开始日期、结束日期、状态","show-icon":"",closable:!1}),p("div",tt,[t(r,{type:"primary",onClick:Se},{default:o(()=>[...e[36]||(e[36]=[c("下载导入模板",-1)])]),_:1}),t(qe,{class:"upload-demo",action:"/api/admin/courses/import",headers:ce,"on-success":Ie,"on-error":Ye,"before-upload":ze,accept:".xlsx, .xls"},{default:o(()=>[t(r,{type:"success"},{default:o(()=>[...e[37]||(e[37]=[c("选择文件并上传",-1)])]),_:1})]),_:1})])])]),_:1},8,["modelValue"])])}}},rt=Be(at,[["__scopeId","data-v-a93ac60b"]]);export{rt as default};
