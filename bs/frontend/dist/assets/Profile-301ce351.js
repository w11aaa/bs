import{_ as j,h as y,v as P,j as R,b as p,k as S,o as U,c as I,d as k,e,w as o,a as C,E as c,m as D,g as N,f as b}from"./index-48d38f36.js";const B={name:"StudentProfile",setup(){const g=y(null),a=y(null),f=y(!1),l=y(""),F=P({student_id:"",username:"",name:"",email:"",gender:"",age:null,major:"",class_name:""}),v=P({current_password:"",new_password:"",confirm_password:""}),u={name:[{required:!0,message:"请输入姓名",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],gender:[{required:!0,message:"请选择性别",trigger:"change"}]},s={current_password:[{required:!0,message:"请输入当前密码",trigger:"blur"}],new_password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能小于6位",trigger:"blur"}],confirm_password:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(t,d,n)=>{d!==v.new_password?n(new Error("两次输入的密码不一致")):n()},trigger:"blur"}]},i=async()=>{f.value=!0;try{const t=await C.get("/student/profile");t.data&&(Object.assign(F,t.data),t.data.face_image&&(l.value=`/api/static/uploads/face_images/${t.data.face_image}`))}catch(t){console.error("加载个人资料失败:",t),c.error("加载个人资料失败")}finally{f.value=!1}},w=async()=>{g.value&&await g.value.validate(async t=>{var d,n;if(t){f.value=!0;try{await C.put("/student/profile",F),c.success("个人资料更新成功");const m=localStorage.getItem("user");if(m){const r=JSON.parse(m);r.name=F.name,localStorage.setItem("user",JSON.stringify(r))}}catch(m){console.error("更新个人资料失败:",m),c.error(((n=(d=m.response)==null?void 0:d.data)==null?void 0:n.message)||"更新个人资料失败")}finally{f.value=!1}}})},V=()=>{g.value&&(g.value.resetFields(),i())},x=async t=>{var n,m;const d=new FormData;d.append("face_image",t.file),f.value=!0;try{const r=await C.post("/student/profile/face",d,{headers:{"Content-Type":"multipart/form-data"}});r.data&&r.data.face_image&&(l.value=`/api/static/uploads/face_images/${r.data.face_image}?t=${Date.now()}`,c.success("人脸照片更新成功"))}catch(r){console.error("上传人脸照片失败:",r),c.error(((m=(n=r.response)==null?void 0:n.data)==null?void 0:m.message)||"上传人脸照片失败")}finally{f.value=!1}},q=async()=>{a.value&&await a.value.validate(async t=>{var d,n;if(t)try{await C.put("/auth/password",{current_password:v.current_password,new_password:v.new_password}),c.success("密码修改成功"),_()}catch(m){console.error("修改密码失败:",m),c.error(((n=(d=m.response)==null?void 0:d.data)==null?void 0:n.message)||"修改密码失败")}})},_=()=>{a.value&&a.value.resetFields()};return R(()=>{i()}),{profileFormRef:g,passwordFormRef:a,loading:f,profileForm:F,passwordForm:v,rules:u,passwordRules:s,faceImageUrl:l,submitForm:w,resetForm:V,uploadFaceImage:x,changePassword:q,resetPasswordForm:_}}},E={class:"profile-container"},O={class:"face-image-container"},J=["src"],M={key:1,class:"no-image"};function T(g,a,f,l,F,v){const u=p("el-input"),s=p("el-form-item"),i=p("el-col"),w=p("el-row"),V=p("el-option"),x=p("el-select"),q=p("el-input-number"),_=p("el-button"),t=p("el-upload"),d=p("el-form"),n=p("el-card"),m=S("loading");return U(),I("div",E,[a[17]||(a[17]=k("h2",null,"个人资料",-1)),e(n,{class:"profile-card"},{default:o(()=>[D((U(),N(d,{model:l.profileForm,rules:l.rules,ref:"profileFormRef","label-width":"100px"},{default:o(()=>[e(w,{gutter:20},{default:o(()=>[e(i,{span:12},{default:o(()=>[e(s,{label:"学号",prop:"student_id"},{default:o(()=>[e(u,{modelValue:l.profileForm.student_id,"onUpdate:modelValue":a[0]||(a[0]=r=>l.profileForm.student_id=r),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:o(()=>[e(s,{label:"用户名",prop:"username"},{default:o(()=>[e(u,{modelValue:l.profileForm.username,"onUpdate:modelValue":a[1]||(a[1]=r=>l.profileForm.username=r),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(w,{gutter:20},{default:o(()=>[e(i,{span:12},{default:o(()=>[e(s,{label:"姓名",prop:"name"},{default:o(()=>[e(u,{modelValue:l.profileForm.name,"onUpdate:modelValue":a[2]||(a[2]=r=>l.profileForm.name=r)},null,8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:o(()=>[e(s,{label:"邮箱",prop:"email"},{default:o(()=>[e(u,{modelValue:l.profileForm.email,"onUpdate:modelValue":a[3]||(a[3]=r=>l.profileForm.email=r)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(w,{gutter:20},{default:o(()=>[e(i,{span:12},{default:o(()=>[e(s,{label:"性别",prop:"gender"},{default:o(()=>[e(x,{modelValue:l.profileForm.gender,"onUpdate:modelValue":a[4]||(a[4]=r=>l.profileForm.gender=r),placeholder:"请选择性别"},{default:o(()=>[e(V,{label:"男",value:"男"}),e(V,{label:"女",value:"女"}),e(V,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:o(()=>[e(s,{label:"年龄",prop:"age"},{default:o(()=>[e(q,{modelValue:l.profileForm.age,"onUpdate:modelValue":a[5]||(a[5]=r=>l.profileForm.age=r),min:16,max:100},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(w,{gutter:20},{default:o(()=>[e(i,{span:12},{default:o(()=>[e(s,{label:"专业",prop:"major"},{default:o(()=>[e(u,{modelValue:l.profileForm.major,"onUpdate:modelValue":a[6]||(a[6]=r=>l.profileForm.major=r)},null,8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:o(()=>[e(s,{label:"班级",prop:"class_name"},{default:o(()=>[e(u,{modelValue:l.profileForm.class_name,"onUpdate:modelValue":a[7]||(a[7]=r=>l.profileForm.class_name=r)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(s,{label:"人脸照片"},{default:o(()=>[k("div",O,[l.faceImageUrl?(U(),I("img",{key:0,src:l.faceImageUrl,class:"face-image"},null,8,J)):(U(),I("div",M,"暂无人脸照片")),e(t,{class:"upload-btn",action:"#","http-request":l.uploadFaceImage,"show-file-list":!1,accept:"image/*"},{default:o(()=>[e(_,{type:"primary"},{default:o(()=>[...a[11]||(a[11]=[b("更新人脸照片",-1)])]),_:1})]),_:1},8,["http-request"])])]),_:1}),e(s,null,{default:o(()=>[e(_,{type:"primary",onClick:l.submitForm},{default:o(()=>[...a[12]||(a[12]=[b("保存修改",-1)])]),_:1},8,["onClick"]),e(_,{onClick:l.resetForm},{default:o(()=>[...a[13]||(a[13]=[b("重置",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])),[[m,l.loading]])]),_:1}),e(n,{class:"password-card"},{default:o(()=>[a[16]||(a[16]=k("div",{class:"card-header"},[k("h3",null,"修改密码")],-1)),e(d,{model:l.passwordForm,rules:l.passwordRules,ref:"passwordFormRef","label-width":"120px"},{default:o(()=>[e(s,{label:"当前密码",prop:"current_password"},{default:o(()=>[e(u,{modelValue:l.passwordForm.current_password,"onUpdate:modelValue":a[8]||(a[8]=r=>l.passwordForm.current_password=r),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(s,{label:"新密码",prop:"new_password"},{default:o(()=>[e(u,{modelValue:l.passwordForm.new_password,"onUpdate:modelValue":a[9]||(a[9]=r=>l.passwordForm.new_password=r),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(s,{label:"确认新密码",prop:"confirm_password"},{default:o(()=>[e(u,{modelValue:l.passwordForm.confirm_password,"onUpdate:modelValue":a[10]||(a[10]=r=>l.passwordForm.confirm_password=r),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(s,null,{default:o(()=>[e(_,{type:"primary",onClick:l.changePassword},{default:o(()=>[...a[14]||(a[14]=[b("修改密码",-1)])]),_:1},8,["onClick"]),e(_,{onClick:l.resetPasswordForm},{default:o(()=>[...a[15]||(a[15]=[b("重置",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])]),_:1})])}const A=j(B,[["render",T],["__scopeId","data-v-8dc32373"]]);export{A as default};
