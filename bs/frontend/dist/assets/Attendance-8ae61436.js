import{_ as K,a as y,E as c,r as z,b as l,o as g,c as w,e as t,w as n,d as r,f as i,t as _,F as Q,s as X,g as S,n as V}from"./index-48d38f36.js";const Z={name:"TeacherAttendance",components:{},data(){return{user:{},activeMenu:"/teacher/attendance",courses:[],formData:{course_id:"",attendance_date:""},showAttendance:!1,recognizedInfo:null,todayAttendance:[],dialogVisible:!1,editForm:{id:"",student_name:"",status:"",time:"",remark:""},recognitionInterval:null,mediaStream:null}},created(){this.user=JSON.parse(localStorage.getItem("user")),this.loadCourses(),this.loadTodayAttendance();const o=new Date;this.formData.attendance_date=o.toISOString().split("T")[0]},beforeUnmount(){this.stopAttendance()},methods:{async loadCourses(){try{const o=await y.get("/teacher/courses");o.success&&(this.courses=o.data)}catch(o){console.error("Load courses error:",o),c.error("加载课程失败")}},async loadTodayAttendance(){try{const o=await y.get("/teacher/attendance/today");o.success&&(this.todayAttendance=o.data)}catch(o){console.error("Load today attendance error:",o),c.error("加载考勤记录失败")}},async startAttendance(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});const o=this.$refs.videoElement;o.srcObject=this.mediaStream,this.showAttendance=!0,c.success("考勤开始，请学生依次进行人脸识别"),this.recognitionInterval=setInterval(()=>{this.recognizeFace()},5e3)}catch(o){console.error("Start attendance error:",o),c.error("无法访问摄像头，请确保已授权")}},stopAttendance(){this.recognitionInterval&&(clearInterval(this.recognitionInterval),this.recognitionInterval=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(o=>o.stop()),this.mediaStream=null),this.showAttendance=!1,this.recognizedInfo=null,c.success("考勤已停止")},async recognizeFace(){try{const o=this.$refs.videoElement,e=this.$refs.canvasElement,u=e.getContext("2d");e.width=o.videoWidth,e.height=o.videoHeight,u.drawImage(o,0,0,e.width,e.height),e.toBlob(async A=>{const a=new FormData;a.append("face_image",A,"face.jpg"),a.append("course_id",this.formData.course_id),a.append("date",this.formData.attendance_date);try{const d=await y.post("/teacher/attendance/face-recognize",a,{headers:{"Content-Type":"multipart/form-data"}});d.success?(this.recognizedInfo={message:d.message,type:"success",student:d.data,score:d.data.match_score},this.loadTodayAttendance()):this.recognizedInfo={message:d.message,type:"warning"},setTimeout(()=>{this.recognizedInfo=null},3e3)}catch(d){console.error("Face recognition error:",d)}},"image/jpeg")}catch(o){console.error("Capture image error:",o)}},getStatusType(o){switch(o){case"出勤":return"success";case"缺勤":return"danger";case"迟到":return"warning";default:return"info"}},editAttendance(o){this.editForm={id:o.id,student_name:o.student_name,status:o.status,time:o.time,remark:o.remark||""},this.dialogVisible=!0},async saveAttendance(){try{const o=await y.put("/teacher/attendance/update",{id:this.editForm.id,status:this.editForm.status,time:this.editForm.time,remark:this.editForm.remark});o.success?(c.success("修改成功"),this.dialogVisible=!1,this.loadTodayAttendance()):c.error(o.message||"修改失败")}catch(o){console.error("Update attendance error:",o),c.error("修改失败")}},async exportAttendance(){try{const o=await y.get("/teacher/attendance/export",{params:{course_id:this.formData.course_id,date:this.formData.attendance_date},responseType:"blob"}),e=window.URL.createObjectURL(new Blob([o])),u=document.createElement("a");u.href=e,u.setAttribute("download",`考勤记录_${this.formData.attendance_date}.xlsx`),document.body.appendChild(u),u.click(),document.body.removeChild(u),c.success("导出成功")}catch(o){console.error("Export attendance error:",o),c.error("导出失败")}},toProfile(){z.push("/teacher/profile")},logout(){localStorage.removeItem("token"),localStorage.removeItem("user"),z.push("/login"),c.success("退出登录成功")}}},$={class:"attendance-container"},ee={class:"header-content"},te={class:"user-info"},ne={class:"main-content"},oe={class:"card-header"},ae={class:"camera-container"},le={ref:"videoElement",autoplay:""},se={ref:"canvasElement",style:{display:"none"}},re={key:0,class:"attendance-info"},de={key:0},ie={class:"card-header"};function ce(o,e,u,A,a,d){const E=l("ArrowDown"),h=l("el-icon"),x=l("el-dropdown-item"),T=l("el-dropdown-menu"),U=l("el-dropdown"),H=l("el-header"),M=l("Home"),v=l("el-menu-item"),B=l("Document"),L=l("Timer"),N=l("User"),j=l("el-menu"),O=l("el-aside"),b=l("el-option"),C=l("el-select"),m=l("el-form-item"),Y=l("el-date-picker"),p=l("el-button"),D=l("el-form"),k=l("el-card"),P=l("el-alert"),f=l("el-table-column"),R=l("el-tag"),q=l("el-table"),J=l("el-main"),I=l("el-container"),F=l("el-input"),W=l("el-time-picker"),G=l("el-dialog");return g(),w("div",$,[t(I,null,{default:n(()=>[t(H,null,{default:n(()=>[r("div",ee,[e[10]||(e[10]=r("h1",null,"互联网课堂考勤系统 - 教师端",-1)),t(U,null,{dropdown:n(()=>[t(T,null,{default:n(()=>[t(x,{onClick:d.toProfile},{default:n(()=>[...e[8]||(e[8]=[i("个人资料",-1)])]),_:1},8,["onClick"]),t(x,{divided:"",onClick:d.logout},{default:n(()=>[...e[9]||(e[9]=[i("退出登录",-1)])]),_:1},8,["onClick"])]),_:1})]),default:n(()=>[r("span",te,[i(_(a.user.name)+" ",1),t(h,null,{default:n(()=>[t(E)]),_:1})])]),_:1})])]),_:1}),t(I,null,{default:n(()=>[t(O,{width:"200px"},{default:n(()=>[t(j,{"default-active":a.activeMenu,class:"sidebar-menu",router:"","unique-opened":!0},{default:n(()=>[t(v,{index:"/teacher/dashboard"},{default:n(()=>[t(h,null,{default:n(()=>[t(M)]),_:1}),e[11]||(e[11]=r("span",null,"仪表板",-1))]),_:1}),t(v,{index:"/teacher/courses"},{default:n(()=>[t(h,null,{default:n(()=>[t(B)]),_:1}),e[12]||(e[12]=r("span",null,"我的课程",-1))]),_:1}),t(v,{index:"/teacher/attendance"},{default:n(()=>[t(h,null,{default:n(()=>[t(L)]),_:1}),e[13]||(e[13]=r("span",null,"考勤管理",-1))]),_:1}),t(v,{index:"/teacher/profile"},{default:n(()=>[t(h,null,{default:n(()=>[t(N)]),_:1}),e[14]||(e[14]=r("span",null,"个人资料",-1))]),_:1})]),_:1},8,["default-active"])]),_:1}),t(J,null,{default:n(()=>[r("div",ne,[e[24]||(e[24]=r("h2",null,"人脸识别考勤",-1)),t(k,{shadow:"hover"},{header:n(()=>[...e[15]||(e[15]=[r("div",{class:"card-header"},[r("span",null,"选择课程")],-1)])]),default:n(()=>[t(D,{model:a.formData,"label-width":"80px"},{default:n(()=>[t(m,{label:"课程"},{default:n(()=>[t(C,{modelValue:a.formData.course_id,"onUpdate:modelValue":e[0]||(e[0]=s=>a.formData.course_id=s),placeholder:"请选择课程"},{default:n(()=>[(g(!0),w(Q,null,X(a.courses,s=>(g(),S(b,{key:s.id,label:s.course_name,value:s.id},{default:n(()=>[i(_(s.course_name)+" ("+_(s.course_code)+") ",1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"考勤日期"},{default:n(()=>[t(Y,{modelValue:a.formData.attendance_date,"onUpdate:modelValue":e[1]||(e[1]=s=>a.formData.attendance_date=s),type:"date",placeholder:"选择日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(m,null,{default:n(()=>[t(p,{type:"primary",onClick:d.startAttendance,disabled:!a.formData.course_id||!a.formData.attendance_date},{default:n(()=>[...e[16]||(e[16]=[i(" 开始考勤 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1}),a.showAttendance?(g(),S(k,{key:0,shadow:"hover",class:"mt-20"},{header:n(()=>[r("div",oe,[e[18]||(e[18]=r("span",null,"人脸识别",-1)),t(p,{type:"danger",onClick:d.stopAttendance},{default:n(()=>[...e[17]||(e[17]=[i("停止考勤",-1)])]),_:1},8,["onClick"])])]),default:n(()=>[r("div",ae,[r("video",le,null,512),r("canvas",se,null,512),a.recognizedInfo?(g(),w("div",re,[t(P,{title:a.recognizedInfo.message,type:a.recognizedInfo.type,"show-icon":""},{desc:n(()=>[a.recognizedInfo.student?(g(),w("div",de,[i(" 学生: "+_(a.recognizedInfo.student.name),1),e[19]||(e[19]=r("br",null,null,-1)),i(" 学号: "+_(a.recognizedInfo.student.student_id),1),e[20]||(e[20]=r("br",null,null,-1)),i(" 匹配度: "+_(a.recognizedInfo.score)+"% ",1)])):V("",!0)]),_:1},8,["title","type"])])):V("",!0)])]),_:1})):V("",!0),t(k,{shadow:"hover",class:"mt-20"},{header:n(()=>[r("div",ie,[e[22]||(e[22]=r("span",null,"今日考勤记录",-1)),t(p,{type:"primary",onClick:d.exportAttendance},{default:n(()=>[...e[21]||(e[21]=[i("导出Excel",-1)])]),_:1},8,["onClick"])])]),default:n(()=>[t(q,{data:a.todayAttendance,style:{width:"100%"}},{default:n(()=>[t(f,{prop:"student_name",label:"学生姓名"}),t(f,{prop:"student_id",label:"学号"}),t(f,{prop:"time",label:"签到时间"}),t(f,{prop:"status",label:"状态"},{default:n(({row:s})=>[t(R,{type:d.getStatusType(s.status)},{default:n(()=>[i(_(s.status),1)]),_:2},1032,["type"])]),_:1}),t(f,{prop:"match_score",label:"匹配度"}),t(f,{prop:"action",label:"操作"},{default:n(({row:s})=>[t(p,{type:"primary",size:"small",onClick:ue=>d.editAttendance(s)},{default:n(()=>[...e[23]||(e[23]=[i(" 编辑 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})])]),_:1})]),_:1})]),_:1}),t(G,{modelValue:a.dialogVisible,"onUpdate:modelValue":e[7]||(e[7]=s=>a.dialogVisible=s),title:"编辑考勤记录",width:"500px"},{footer:n(()=>[t(p,{onClick:e[6]||(e[6]=s=>a.dialogVisible=!1)},{default:n(()=>[...e[25]||(e[25]=[i("取消",-1)])]),_:1}),t(p,{type:"primary",onClick:d.saveAttendance},{default:n(()=>[...e[26]||(e[26]=[i("保存",-1)])]),_:1},8,["onClick"])]),default:n(()=>[t(D,{model:a.editForm,"label-width":"80px"},{default:n(()=>[t(m,{label:"学生姓名"},{default:n(()=>[t(F,{modelValue:a.editForm.student_name,"onUpdate:modelValue":e[2]||(e[2]=s=>a.editForm.student_name=s),disabled:""},null,8,["modelValue"])]),_:1}),t(m,{label:"状态"},{default:n(()=>[t(C,{modelValue:a.editForm.status,"onUpdate:modelValue":e[3]||(e[3]=s=>a.editForm.status=s)},{default:n(()=>[t(b,{label:"出勤",value:"出勤"}),t(b,{label:"迟到",value:"迟到"}),t(b,{label:"缺勤",value:"缺勤"})]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"签到时间"},{default:n(()=>[t(W,{modelValue:a.editForm.time,"onUpdate:modelValue":e[4]||(e[4]=s=>a.editForm.time=s),placeholder:"选择时间",format:"HH:mm:ss","value-format":"HH:mm:ss"},null,8,["modelValue"])]),_:1}),t(m,{label:"备注"},{default:n(()=>[t(F,{modelValue:a.editForm.remark,"onUpdate:modelValue":e[5]||(e[5]=s=>a.editForm.remark=s),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const _e=K(Z,[["render",ce],["__scopeId","data-v-48c4bdef"]]);export{_e as default};
